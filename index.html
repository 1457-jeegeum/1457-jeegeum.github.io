<!doctype html>
<html lang="ko">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>간단 채팅 + YouTube 음악 플레이어</title>
	<style>
		/* ...existing code... */
		body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", "Apple SD Gothic Neo", "Malgun Gothic", sans-serif; margin:0; padding:0; display:flex; height:100vh; }
		#app { display:flex; flex:1; gap:12px; padding:12px; box-sizing:border-box; }
		.panel { background:#fafafa; border:1px solid #e0e0e0; border-radius:8px; padding:12px; box-sizing:border-box; }
		#chatPanel { width:36%; display:flex; flex-direction:column; }
		#ytPanel { flex:1; display:flex; flex-direction:column; }
		.messages { flex:1; overflow:auto; padding:8px; border-radius:6px; background:#fff; border:1px solid #eee; }
		.msg { margin:6px 0; }
		.msg.user { text-align:right; }
		.msg .bubble { display:inline-block; padding:8px 10px; border-radius:12px; max-width:80%; }
		.msg.user .bubble { background:#0078d4; color:#fff; }
		.msg.bot .bubble { background:#f1f1f1; color:#222; }
		.inputRow { display:flex; gap:8px; margin-top:8px; }
		input[type="text"] { flex:1; padding:8px 10px; border:1px solid #ccc; border-radius:6px; }
		button { padding:8px 12px; border-radius:6px; border:1px solid #bbb; background:#fff; cursor:pointer; }
		.searchRow { display:flex; gap:8px; margin-bottom:8px; }
		.results { overflow:auto; display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:10px; }
		.result { display:flex; gap:8px; padding:8px; border:1px solid #eee; border-radius:8px; align-items:center; background:#fff; }
		.result img { width:120px; height:68px; object-fit:cover; border-radius:4px; }
		.result .meta { flex:1; }
		.playerWrap { margin-top:10px; border:1px solid #e7e7e7; border-radius:8px; padding:8px; background:#fff; }
		.small { font-size:12px; color:#666; }
	</style>
</head>
<body>
	<div id="app">
		<div id="chatPanel" class="panel">
			<h3>채팅</h3>
			<div class="messages" id="messages"></div>
			<div class="inputRow">
				<input id="chatInput" type="text" placeholder='메시지 입력 ("/yt 검색어"로 바로 검색)' />
				<button id="sendBtn">전송</button>
			</div>
		</div>

		<div id="ytPanel" class="panel">
			<h3>YouTube 음악</h3>
			<div class="searchRow">
				<input id="searchInput" type="text" placeholder="URL 또는 비디오 ID" />
				<button id="searchBtn">검색</button>
			</div>

			<div id="results" class="results"></div>
 
 			<div class="playerWrap">
 				<div id="player" style="width:100%;height:360px;background:#000;"></div>
 				<div class="small" id="nowInfo">재생 정보 없음</div>
 			</div>
 		</div>
	</div>

	<script>
		// ...existing code...
		const messagesEl = document.getElementById('messages');
		const chatInput = document.getElementById('chatInput');
		const sendBtn = document.getElementById('sendBtn');

		const searchInput = document.getElementById('searchInput');
		const searchBtn = document.getElementById('searchBtn');
		const resultsEl = document.getElementById('results');
		const nowInfo = document.getElementById('nowInfo');

		let ytPlayer = null;
		let ytReady = false;

		// 유튜브 IFrame API 로드
		const tag = document.createElement('script');
		tag.src = "https://www.youtube.com/iframe_api";
		document.head.appendChild(tag);

		function onYouTubeIframeAPIReady() {
			ytReady = true;
			// 플레이어는 최초 재생 시 생성
		}
		window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;

		function createPlayer(videoId) {
			if (!ytReady) {
				console.warn('YT API not ready yet.');
			}
			if (ytPlayer) {
				ytPlayer.loadVideoById(videoId);
				return;
			}
			ytPlayer = new YT.Player('player', {
				height: '360',
				width: '100%',
				videoId: videoId,
				playerVars: { controls: 1, rel: 0 },
				events: {
					onReady: function(e) { e.target.playVideo(); },
					onStateChange: function(e) {
						// 필요 시 상태 처리
					}
				}
			});
		}

		function renderMessage(text, who='user') {
			const div = document.createElement('div');
			div.className = 'msg ' + (who==='user' ? 'user' : 'bot');
			const b = document.createElement('div');
			b.className = 'bubble';
			b.textContent = text;
			div.appendChild(b);
			messagesEl.appendChild(div);
			messagesEl.scrollTop = messagesEl.scrollHeight;
		}

		function extractVideoId(input) {
			let match = input.match(/[?&]v=([a-zA-Z0-9_-]{11})/);
			if (match) return match[1];
			match = input.match(/youtu\.be\/([a-zA-Z0-9_-]{11})/);
			if (match) return match[1];
			if (/^[a-zA-Z0-9_-]{11}$/.test(input.trim())) return input.trim();
			return null;
		}

		function doPlay(input) {
			const vid = extractVideoId(input);
			if (!vid) {
				alert('유효한 YouTube URL 또는 비디오 ID가 아닙니다.\n예: https://www.youtube.com/watch?v=dQw4w9WgXcQ');
				return;
			}
			nowInfo.textContent = `재생 중: ${vid}`;
			resultsEl.innerHTML = '';
			if (ytReady) createPlayer(vid);
			else {
				const wait = setInterval(() => {
					if (ytReady) { clearInterval(wait); createPlayer(vid); }
				}, 200);
			}
		}

		function botReply(userText) {
			const t = userText.toLowerCase();
			if (t.startsWith('/yt ')) {
				const q = userText.slice(4).trim();
				if (q) {
					renderMessage('재생 시도: ' + q, 'bot');
					doPlay(q);
					return;
				}
			}
			if (t.includes('안녕') || t.includes('hi')) {
				renderMessage('안녕하세요! URL이나 비디오 ID를 입력하면 재생됩니다. "/yt URL" 형식으로도 가능합니다.', 'bot');
				return;
			}
			// 기본 에코
			renderMessage('알겠습니다: ' + userText, 'bot');
		}

		sendBtn.addEventListener('click', () => {
			const v = chatInput.value.trim();
			if (!v) return;
			renderMessage(v, 'user');
			chatInput.value = '';
			botReply(v);
		});
		chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendBtn.click(); });

		searchBtn.addEventListener('click', () => {
			const q = searchInput.value.trim();
			if (q) doPlay(q);
		});
		searchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') searchBtn.click(); });

		// 초기 예시 메시지
		renderMessage('안녕하세요! YouTube URL 또는 비디오 ID를 입력하면 재생됩니다.', 'bot');
	</script>
</body>
</html>
