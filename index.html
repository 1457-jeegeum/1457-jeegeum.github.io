<!doctype html>
<html lang="ko">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>간단 채팅 + YouTube 음악 플레이어</title>
	<style>
		/* ...existing code... */
		body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", "Apple SD Gothic Neo", "Malgun Gothic", sans-serif; margin:0; padding:0; display:flex; height:100vh; }
		#app { display:flex; flex:1; gap:12px; padding:12px; box-sizing:border-box; flex-direction:row; }
		.panel { background:#fafafa; border:1px solid #e0e0e0; border-radius:8px; padding:12px; box-sizing:border-box; }
		#chatPanel { width:36%; display:flex; flex-direction:column; min-width:250px; }
		#ytPanel { flex:1; display:flex; flex-direction:column; }
		.messages { flex:1; overflow:auto; padding:8px; border-radius:6px; background:#fff; border:1px solid #eee; }
		.msg { margin:6px 0; }
		.msg.user { text-align:right; }
		.msg .bubble { display:inline-block; padding:8px 10px; border-radius:12px; max-width:80%; }
		.msg.user .bubble { background:#0078d4; color:#fff; }
		.msg.bot .bubble { background:#f1f1f1; color:#222; }
		.inputRow { display:flex; gap:8px; margin-top:8px; }
		input[type="text"] { flex:1; padding:10px 12px; border:1px solid #ccc; border-radius:6px; font-size:16px; }
		button { padding:10px 14px; border-radius:6px; border:1px solid #bbb; background:#fff; cursor:pointer; font-size:14px; font-weight:600; }
		button:active { background:#e8e8e8; }
		.searchRow { display:flex; gap:8px; margin-bottom:8px; }
		.results { overflow:auto; display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:10px; }
		.result { display:flex; gap:8px; padding:8px; border:1px solid #eee; border-radius:8px; align-items:center; background:#fff; }
		.result img { width:120px; height:68px; object-fit:cover; border-radius:4px; }
		.result .meta { flex:1; }
		.playerWrap { margin-top:10px; border:1px solid #e7e7e7; border-radius:8px; padding:8px; background:#fff; }
		.small { font-size:12px; color:#666; }

		/* 모바일 반응형 */
		@media (max-width: 768px) {
			#app { flex-direction:column; padding:8px; gap:8px; }
			#chatPanel { width:100%; }
			#ytPanel { width:100%; }
			.messages { height:200px; }
			.results { grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); }
			.result { flex-direction:column; align-items:flex-start; }
			.result img { width:100%; height:auto; }
			.result .meta { width:100%; }
			.playerWrap { margin-top:8px; padding:6px; }
			#player { height:auto !important; aspect-ratio:16/9; }
			h3 { margin:0 0 8px 0; font-size:16px; }
			.panel { padding:8px; }
			input[type="text"] { font-size:16px; padding:10px 12px; }
			button { padding:12px 14px; font-size:15px; }
		}

		@media (max-width: 480px) {
			#app { padding:6px; gap:6px; }
			.messages { height:150px; }
			.results { grid-template-columns:1fr; }
			.result { gap:6px; padding:6px; }
			.result img { width:100px; height:56px; }
			.small { font-size:11px; }
			h3 { font-size:14px; }
			.panel { padding:6px; }
		}
 	</style>
</head>
<body>
	<div id="app">
		<div id="chatPanel" class="panel">
			<h3>채팅</h3>
			<div class="messages" id="messages"></div>
			<div class="inputRow">
				<input id="chatInput" type="text" placeholder='메시지 입력 ("/yt 검색어"로 바로 검색)' />
				<button id="sendBtn">전송</button>
			</div>
		</div>

		<div id="ytPanel" class="panel">
			<h3>YouTube 음악</h3>
			<div class="searchRow">
				<input id="searchInput" type="text" placeholder="검색어 또는 URL" />
				<button id="searchBtn" style="flex-shrink:0;">검색</button>
			</div>

			<div id="results" class="results"></div>

			<div class="playerWrap">
				<div id="player" style="width:100%;height:360px;background:#000;aspect-ratio:16/9;"></div>
				<div class="small" id="nowInfo">재생 정보 없음</div>
			</div>
		</div>
	</div>

	<script>
		// ...existing code...
		// 설정: 여기에 자신의 YouTube Data API Key를 넣으세요.
		const API_KEY = ''; // <-- 여기에 키를 입력하세요

		const messagesEl = document.getElementById('messages');
		const chatInput = document.getElementById('chatInput');
		const sendBtn = document.getElementById('sendBtn');

		const searchInput = document.getElementById('searchInput');
		const searchBtn = document.getElementById('searchBtn');
		const resultsEl = document.getElementById('results');
		const nowInfo = document.getElementById('nowInfo');

		let ytPlayer = null;
		let ytReady = false;

		// 유튜브 IFrame API 로드
		const tag = document.createElement('script');
		tag.src = "https://www.youtube.com/iframe_api";
		document.head.appendChild(tag);

		function onYouTubeIframeAPIReady() {
			ytReady = true;
			// 플레이어는 최초 재생 시 생성
		}
		window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;

		function createPlayer(videoId) {
			if (!ytReady) {
				console.warn('YT API not ready yet.');
			}
			if (ytPlayer) {
				ytPlayer.loadVideoById(videoId);
				return;
			}
			ytPlayer = new YT.Player('player', {
				height: '360',
				width: '100%',
				videoId: videoId,
				playerVars: { controls: 1, rel: 0 },
				events: {
					onReady: function(e) { e.target.playVideo(); },
					onStateChange: function(e) {
						// 필요 시 상태 처리
					}
				}
			});
		}

		function renderMessage(text, who='user') {
			const div = document.createElement('div');
			div.className = 'msg ' + (who==='user' ? 'user' : 'bot');
			const b = document.createElement('div');
			b.className = 'bubble';
			b.textContent = text;
			div.appendChild(b);
			messagesEl.appendChild(div);
			messagesEl.scrollTop = messagesEl.scrollHeight;
		}

		function botReply(userText) {
			// 간단한 키워드 기반 응답
			const t = userText.toLowerCase();
			if (t.startsWith('/yt ')) {
				const q = userText.slice(4).trim();
				if (q) {
					renderMessage('검색 중: ' + q, 'bot');
					doSearch(q);
					return;
				}
			}
			if (t.includes('안녕') || t.includes('hi')) {
				renderMessage('안녕하세요! "/yt 검색어"로 유튜브 음악을 검색할 수 있습니다.', 'bot');
				return;
			}
			// 기본 에코
			renderMessage('알겠습니다: ' + userText, 'bot');
		}

		sendBtn.addEventListener('click', () => {
			const v = chatInput.value.trim();
			if (!v) return;
			renderMessage(v, 'user');
			chatInput.value = '';
			botReply(v);
		});
		chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendBtn.click(); });

		// YouTube 검색
		async function doSearch(query) {
			if (!API_KEY) {
				alert('YouTube API 키가 설정되어 있지 않습니다. sh.html 파일의 API_KEY 변수에 키를 넣으세요.');
				return;
			}
			const url = 'https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=12&q=' + encodeURIComponent(query) + '&key=' + API_KEY;
			try {
				const res = await fetch(url);
				if (!res.ok) throw new Error('HTTP ' + res.status);
				const data = await res.json();
				renderResults(data.items || []);
			} catch (err) {
				console.error(err);
				alert('검색 중 오류가 발생했습니다. 콘솔을 확인하세요.');
			}
		}

		function renderResults(items) {
			resultsEl.innerHTML = '';
			if (!items.length) {
				resultsEl.textContent = '결과 없음';
				return;
			}
			for (const it of items) {
				const vid = it.id.videoId;
				const thumb = it.snippet.thumbnails.medium?.url || it.snippet.thumbnails.default?.url || '';
				const title = it.snippet.title;
				const channel = it.snippet.channelTitle;
				const div = document.createElement('div');
				div.className = 'result';
				div.innerHTML = `
					<img src="${thumb}" alt="${title}">
					<div class="meta">
						<div style="font-weight:600;">${escapeHtml(title)}</div>
						<div class="small">${escapeHtml(channel)}</div>
						<div style="margin-top:6px;">
							<button data-vid="${vid}">재생</button>
						</div>
					</div>
				`;
				resultsEl.appendChild(div);
				div.querySelector('button').addEventListener('click', () => {
					nowInfo.textContent = `재생중: ${title} — ${channel}`;
					if (ytReady) createPlayer(vid);
					else {
						// 큐해서 API 준비 후 재생
						const wait = setInterval(() => {
							if (ytReady) { clearInterval(wait); createPlayer(vid); }
						}, 200);
					}
				});
			}
		}

		function escapeHtml(s) {
			return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
		}

		searchBtn.addEventListener('click', () => {
			const q = searchInput.value.trim();
			if (q) doSearch(q);
		});
		searchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') searchBtn.click(); });

		// 초기 예시 메시지
		renderMessage('안녕하세요! 오른쪽에서 유튜브 음악을 검색하고 재생할 수 있습니다. 채팅에서 "/yt 검색어"로도 검색 가능.', 'bot');
	</script>
</body>
</html>
